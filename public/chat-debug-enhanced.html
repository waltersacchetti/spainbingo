<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Debug Enhanced - BingoRoyal</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .debug-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .debug-section h3 {
            margin-top: 0;
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .status-offline {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
        }
        
        .status-warning {
            background: #FF9800;
            box-shadow: 0 0 10px #FF9800;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        
        .log-info {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }
        
        .log-success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }
        
        .log-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 3px solid #FF9800;
        }
        
        .log-error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }
        
        .test-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .test-passed {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: #4CAF50;
        }
        
        .test-failed {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-card h4 {
            margin-top: 0;
            color: #ffd700;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        
        .chat-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .chat-message {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #4CAF50;
        }
        
        .message-time {
            font-size: 11px;
            color: #ccc;
        }
        
        .message-user {
            font-weight: bold;
            color: #ffd700;
        }
        
        .message-text {
            color: #fff;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Chat Debug Enhanced - BingoRoyal</h1>
            <p>Herramientas avanzadas de diagn√≥stico para el sistema de chat en vivo</p>
        </div>

        <!-- Estado del Sistema -->
        <div class="debug-section">
            <h3>üìä Estado del Sistema</h3>
            <div class="grid">
                <div class="info-card">
                    <h4>Estado del Chat</h4>
                    <div class="status-indicator" id="chatStatus"></div>
                    <span id="chatStatusText">Verificando...</span>
                </div>
                <div class="info-card">
                    <h4>Usuario Actual</h4>
                    <div class="info-value" id="currentUser">Verificando...</div>
                </div>
                <div class="info-card">
                    <h4>URL de la API</h4>
                    <div class="info-value" id="apiUrl">Verificando...</div>
                </div>
                <div class="info-card">
                    <h4>Conectividad</h4>
                    <div class="info-value" id="connectivity">Verificando...</div>
                </div>
            </div>
        </div>

        <!-- Pruebas Autom√°ticas -->
        <div class="debug-section">
            <h3>üß™ Pruebas Autom√°ticas</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="runAllTests()">üöÄ Ejecutar Todas las Pruebas</button>
                <button class="btn btn-secondary" onclick="testConfiguration()">üìã Probar Configuraci√≥n</button>
                <button class="btn btn-secondary" onclick="testDOMElements()">üèóÔ∏è Probar Elementos DOM</button>
                <button class="btn btn-secondary" onclick="testApiConnectivity()">üîó Probar Conectividad API</button>
                <button class="btn btn-secondary" onclick="testChatFunctionality()">üí¨ Probar Funcionalidad Chat</button>
            </div>
            <div id="testResults" class="test-results"></div>
        </div>

        <!-- Pruebas Manuales -->
        <div class="debug-section">
            <h3>üîß Pruebas Manuales</h3>
            <div class="button-group">
                <button class="btn btn-warning" onclick="testMessageSending()">üì§ Probar Env√≠o de Mensaje</button>
                <button class="btn btn-warning" onclick="testMessageLoading()">üì• Probar Carga de Mensajes</button>
                <button class="btn btn-warning" onclick="testChatInput()">‚å®Ô∏è Probar Input del Chat</button>
                <button class="btn btn-warning" onclick="testChatToggle()">üîÑ Probar Toggle del Chat</button>
            </div>
        </div>

        <!-- Diagn√≥stico de Problemas -->
        <div class="debug-section">
            <h3>üîç Diagn√≥stico de Problemas</h3>
            <div class="button-group">
                <button class="btn btn-danger" onclick="detectChatIssues()">üö® Detectar Problemas</button>
                <button class="btn btn-danger" onclick="fixChatIssues()">üîß Intentar Reparar</button>
                <button class="btn btn-danger" onclick="resetChatSystem()">üîÑ Resetear Sistema</button>
                <button class="btn btn-danger" onclick="clearChatLogs()">üóëÔ∏è Limpiar Logs</button>
            </div>
        </div>

        <!-- Vista Previa del Chat -->
        <div class="debug-section">
            <h3>üí¨ Vista Previa del Chat</h3>
            <div class="chat-preview" id="chatPreview">
                <div class="chat-message">
                    <div class="message-time">12:00:00</div>
                    <div class="message-user">Sistema:</div>
                    <div class="message-text">Chat inicializado correctamente</div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="refreshChatPreview()">üîÑ Actualizar Vista</button>
                <button class="btn btn-secondary" onclick="addTestMessage()">‚ûï Agregar Mensaje de Prueba</button>
            </div>
        </div>

        <!-- Logs del Sistema -->
        <div class="debug-section">
            <h3>üìù Logs del Sistema</h3>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
                <button class="btn btn-secondary" onclick="exportLogs()">üíæ Exportar Logs</button>
                <button class="btn btn-secondary" onclick="toggleAutoScroll()">üìú Auto-scroll</button>
            </div>
            <div id="systemLogs" class="log-container"></div>
        </div>

        <!-- Informaci√≥n del Navegador -->
        <div class="debug-section">
            <h3>üåê Informaci√≥n del Navegador</h3>
            <div class="grid">
                <div class="info-card">
                    <h4>User Agent</h4>
                    <div class="info-value" id="userAgent">Verificando...</div>
                </div>
                <div class="info-card">
                    <h4>Local Storage</h4>
                    <div class="info-value" id="localStorageStatus">Verificando...</div>
                </div>
                <div class="info-card">
                    <h4>Session Storage</h4>
                    <div class="info-value" id="sessionStorageStatus">Verificando...</div>
                </div>
                <div class="info-card">
                    <h4>Cookies</h4>
                    <div class="info-value" id="cookiesStatus">Verificando...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let autoScroll = true;
        let systemLogs = [];
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Chat Debug Enhanced inicializado');
            initializeDebugSystem();
        });
        
        /**
         * Inicializar sistema de debugging
         */
        function initializeDebugSystem() {
            addLog('Sistema de debugging inicializado', 'info');
            updateSystemStatus();
            updateBrowserInfo();
            
            // Actualizar estado cada 5 segundos
            setInterval(updateSystemStatus, 5000);
        }
        
        /**
         * Actualizar estado del sistema
         */
        function updateSystemStatus() {
            try {
                // Estado del chat
                const chatStatus = document.getElementById('chatStatus');
                const chatStatusText = document.getElementById('chatStatusText');
                
                if (window.bingoGame && window.bingoGame.chatInitialized) {
                    chatStatus.className = 'status-indicator status-online';
                    chatStatusText.textContent = 'Chat Activo';
                } else {
                    chatStatus.className = 'status-indicator status-offline';
                    chatStatusText.textContent = 'Chat Inactivo';
                }
                
                // Usuario actual
                const currentUser = document.getElementById('currentUser');
                if (window.chatConfig) {
                    const user = window.chatConfig.getCurrentUser();
                    currentUser.textContent = user.name;
                } else {
                    currentUser.textContent = 'No disponible';
                }
                
                // URL de la API
                const apiUrl = document.getElementById('apiUrl');
                if (window.chatConfig) {
                    apiUrl.textContent = window.chatConfig.getApiUrl();
                } else {
                    apiUrl.textContent = 'No disponible';
                }
                
                // Conectividad
                const connectivity = document.getElementById('connectivity');
                if (window.chatConfig && window.chatConfig.isConnected) {
                    connectivity.textContent = 'Conectado';
                } else {
                    connectivity.textContent = 'Desconectado';
                }
                
            } catch (error) {
                addLog('Error actualizando estado del sistema: ' + error.message, 'error');
            }
        }
        
        /**
         * Actualizar informaci√≥n del navegador
         */
        function updateBrowserInfo() {
            try {
                // User Agent
                document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 50) + '...';
                
                // Local Storage
                const localStorageStatus = document.getElementById('localStorageStatus');
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    localStorageStatus.textContent = 'Disponible';
                } catch (e) {
                    localStorageStatus.textContent = 'No disponible';
                }
                
                // Session Storage
                const sessionStorageStatus = document.getElementById('sessionStorageStatus');
                try {
                    sessionStorage.setItem('test', 'test');
                    sessionStorage.removeItem('test');
                    sessionStorageStatus.textContent = 'Disponible';
                } catch (e) {
                    sessionStorageStatus.textContent = 'No disponible';
                }
                
                // Cookies
                const cookiesStatus = document.getElementById('cookiesStatus');
                cookiesStatus.textContent = navigator.cookieEnabled ? 'Habilitadas' : 'Deshabilitadas';
                
            } catch (error) {
                addLog('Error actualizando informaci√≥n del navegador: ' + error.message, 'error');
            }
        }
        
        /**
         * Ejecutar todas las pruebas
         */
        function runAllTests() {
            addLog('Ejecutando todas las pruebas...', 'info');
            
            if (window.runChatTests) {
                window.runChatTests();
            } else {
                addLog('ChatTester no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar configuraci√≥n
         */
        function testConfiguration() {
            addLog('Probando configuraci√≥n del chat...', 'info');
            
            if (window.chatTester) {
                window.chatTester.testConfiguration();
            } else {
                addLog('ChatTester no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar elementos DOM
         */
        function testDOMElements() {
            addLog('Probando elementos del DOM...', 'info');
            
            if (window.chatTester) {
                window.chatTester.testDOMElements();
            } else {
                addLog('ChatTester no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar conectividad de la API
         */
        function testApiConnectivity() {
            addLog('Probando conectividad de la API...', 'info');
            
            if (window.chatTester) {
                window.chatTester.testApiConnectivity();
            } else {
                addLog('ChatTester no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar funcionalidad del chat
         */
        function testChatFunctionality() {
            addLog('Probando funcionalidad del chat...', 'info');
            
            if (window.chatTester) {
                window.chatTester.testChatFunctionality();
            } else {
                addLog('ChatTester no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar env√≠o de mensaje
         */
        function testMessageSending() {
            addLog('Probando env√≠o de mensaje...', 'info');
            
            if (window.testChatMessage) {
                window.testChatMessage();
            } else {
                addLog('Funci√≥n testChatMessage no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar carga de mensajes
         */
        function testMessageLoading() {
            addLog('Probando carga de mensajes...', 'info');
            
            if (window.testChatLoading) {
                window.testChatLoading();
            } else {
                addLog('Funci√≥n testChatLoading no est√° disponible', 'error');
            }
        }
        
        /**
         * Probar input del chat
         */
        function testChatInput() {
            addLog('Probando input del chat...', 'info');
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.focus();
                chatInput.value = 'Mensaje de prueba ' + Date.now();
                addLog('Input del chat probado correctamente', 'success');
            } else {
                addLog('Input del chat no encontrado', 'error');
            }
        }
        
        /**
         * Probar toggle del chat
         */
        function testChatToggle() {
            addLog('Probando toggle del chat...', 'info');
            
            const chatToggle = document.querySelector('.chat-toggle-btn-fixed');
            if (chatToggle) {
                chatToggle.click();
                addLog('Toggle del chat probado correctamente', 'success');
            } else {
                addLog('Toggle del chat no encontrado', 'error');
            }
        }
        
        /**
         * Detectar problemas del chat
         */
        function detectChatIssues() {
            addLog('Detectando problemas del chat...', 'info');
            
            const issues = [];
            
            // Verificar si BingoGame est√° disponible
            if (!window.bingoGame) {
                issues.push('BingoGame no est√° disponible');
            }
            
            // Verificar si el chat est√° inicializado
            if (window.bingoGame && !window.bingoGame.chatInitialized) {
                issues.push('Chat no est√° inicializado');
            }
            
            // Verificar si ChatConfig est√° disponible
            if (!window.chatConfig) {
                issues.push('ChatConfig no est√° disponible');
            }
            
            // Verificar elementos del DOM
            const requiredElements = ['chatInput', 'chatSectionFixed', '.chat-toggle-btn-fixed'];
            requiredElements.forEach(selector => {
                const element = selector.startsWith('.') ? 
                    document.querySelector(selector) : 
                    document.getElementById(selector);
                if (!element) {
                    issues.push(`Elemento ${selector} no encontrado`);
                }
            });
            
            if (issues.length === 0) {
                addLog('No se detectaron problemas', 'success');
            } else {
                issues.forEach(issue => {
                    addLog('Problema detectado: ' + issue, 'warning');
                });
            }
        }
        
        /**
         * Intentar reparar problemas del chat
         */
        function fixChatIssues() {
            addLog('Intentando reparar problemas del chat...', 'info');
            
            try {
                // Reinicializar chat si es posible
                if (window.bingoGame && typeof window.bingoGame.initializeLiveChat === 'function') {
                    window.bingoGame.initializeLiveChat();
                    addLog('Chat reinicializado', 'success');
                }
                
                // Verificar conectividad de la API
                if (window.chatConfig) {
                    window.chatConfig.checkApiConnectivity().then(result => {
                        if (result.connected) {
                            addLog('API del chat conectada', 'success');
                        } else {
                            addLog('API del chat no conectada: ' + result.error, 'warning');
                        }
                    });
                }
                
            } catch (error) {
                addLog('Error reparando problemas: ' + error.message, 'error');
            }
        }
        
        /**
         * Resetear sistema del chat
         */
        function resetChatSystem() {
            addLog('Reseteando sistema del chat...', 'warning');
            
            try {
                if (window.chatConfig) {
                    window.chatConfig.reset();
                    addLog('ChatConfig reseteado', 'success');
                }
                
                if (window.bingoGame) {
                    window.bingoGame.chatInitialized = false;
                    addLog('Estado del chat reseteado', 'success');
                }
                
                // Limpiar logs
                clearLogs();
                
                addLog('Sistema del chat reseteado', 'success');
                
            } catch (error) {
                addLog('Error reseteando sistema: ' + error.message, 'error');
            }
        }
        
        /**
         * Limpiar logs del chat
         */
        function clearChatLogs() {
            addLog('Limpiando logs del chat...', 'info');
            
            try {
                if (window.chatConfig) {
                    window.chatConfig.clearLocalMessages();
                    addLog('Logs del chat limpiados', 'success');
                }
            } catch (error) {
                addLog('Error limpiando logs del chat: ' + error.message, 'error');
            }
        }
        
        /**
         * Actualizar vista previa del chat
         */
        function refreshChatPreview() {
            addLog('Actualizando vista previa del chat...', 'info');
            
            const chatPreview = document.getElementById('chatPreview');
            if (chatPreview) {
                // Aqu√≠ podr√≠as cargar mensajes reales del chat
                addLog('Vista previa del chat actualizada', 'success');
            }
        }
        
        /**
         * Agregar mensaje de prueba
         */
        function addTestMessage() {
            addLog('Agregando mensaje de prueba...', 'info');
            
            const chatPreview = document.getElementById('chatPreview');
            if (chatPreview) {
                const testMessage = document.createElement('div');
                testMessage.className = 'chat-message';
                testMessage.innerHTML = `
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    <div class="message-user">Usuario de Prueba:</div>
                    <div class="message-text">Este es un mensaje de prueba para verificar el sistema</div>
                `;
                
                chatPreview.appendChild(testMessage);
                addLog('Mensaje de prueba agregado', 'success');
            }
        }
        
        /**
         * Limpiar logs
         */
        function clearLogs() {
            systemLogs = [];
            document.getElementById('systemLogs').innerHTML = '';
            addLog('Logs del sistema limpiados', 'info');
        }
        
        /**
         * Exportar logs
         */
        function exportLogs() {
            addLog('Exportando logs...', 'info');
            
            try {
                const logText = systemLogs.map(log => 
                    `[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}`
                ).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat-debug-logs-${new Date().toISOString().slice(0, 19)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                addLog('Logs exportados correctamente', 'success');
            } catch (error) {
                addLog('Error exportando logs: ' + error.message, 'error');
            }
        }
        
        /**
         * Toggle auto-scroll
         */
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            addLog(`Auto-scroll ${autoScroll ? 'habilitado' : 'deshabilitado'}`, 'info');
        }
        
        /**
         * Agregar log al sistema
         */
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp: timestamp,
                message: message,
                level: level
            };
            
            systemLogs.push(logEntry);
            
            // Limitar logs a 100 entradas
            if (systemLogs.length > 100) {
                systemLogs.shift();
            }
            
            // Actualizar UI
            const logsContainer = document.getElementById('systemLogs');
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${level}`;
            logElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logsContainer.appendChild(logElement);
            
            // Auto-scroll
            if (autoScroll) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // Tambi√©n mostrar en consola
            console.log(`[${level.toUpperCase()}] ${message}`);
        }
        
        // Interceptar console.log para mostrar en la UI
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addLog(args.join(' '), 'info');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addLog(args.join(' '), 'warning');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLog(args.join(' '), 'error');
        };
    </script>
</body>
</html>
